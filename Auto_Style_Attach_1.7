// ==UserScript==
// @name        Auto Style Attach â­
// @namespace  http://tampermonkey.net/
// @version      1.7
// @description  æ–‡æ›¸æœ«å°¾ã«å¸¸è¨­ styleã‚¿ã‚°ã‚’è‡ªå‹•è¨˜å…¥ã™ã‚‹
// @author       Ameba Blog User
// @match        https://blog.ameba.jp/ucs/entry/srventry*
// @exclude      https://blog.ameba.jp/ucs/entry/srventrylist.do*
// @grant         none
// ==/UserScript==

// æ–‡æ›¸ä¿å­˜æ™‚ï¼ˆä¸‹æ›¸ãã‚’å«ã‚€å…¨æŠ•ç¨¿æ™‚ï¼‰ã«å¸¸è¨­ styleã‚¿ã‚°ã‚’æ›¸è¾¼ã¿ã¾ã™
// SNSãƒœã‚¿ãƒ³éè¡¨ç¤ºã‚’è¨­å®šã§ãã¾ã™ï¼ˆPCè¡¨ç¤ºã®ã¿ï¼‰


let retry=0;
let interval=setInterval(wait_target, 100);
function wait_target(){
    retry++;
    if(retry>10){ // ãƒªãƒˆãƒ©ã‚¤åˆ¶é™ 10å› 1sec
        clearInterval(interval); }
    let target=document.getElementById('cke_1_contents'); // ç›£è¦– target
    if(target){
        clearInterval(interval);
        main(); }}


function main(){
    sessionStorage.setItem("jslord_3", "1"); // ğŸ“›

    let target=document.getElementById('cke_1_contents'); // ç›£è¦– target
    let monitor=new MutationObserver(catch_publish);
    monitor.observe(target, {childList: true}); // é€šå¸¸ãƒ»HTMLç·¨é›†åˆ‡æ›ã«ã‚ˆã‚‹ç™ºç«ä¸èƒ½ã‚’é˜²ã

    catch_publish();

    function catch_publish(){

        panel_add();

        let all_check=document.querySelector('#allFlg');
        if(all_check){
            report();
            all_check.onclick=function(event){
                if(report()==-1){ // HTMLè¡¨ç¤ºã§ãƒã‚§ãƒƒã‚¯ä¸å¯èƒ½
                    event.preventDefault(); }
                else{ // é€šå¸¸è¡¨ç¤ºã§ã®ã¿ãƒã‚§ãƒƒã‚¯å¯èƒ½
                    if(report()==0){
                        insert_ptag(1);
                        report(); }
                    else if(report()==1){
                        insert_ptag(0);
                        report(); }}}}


        function report(){
            let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
            if(editor_iframe){ // iframeèª­è¾¼ã¿ãŒå®Ÿè¡Œæ¡ä»¶
                let iframe_doc=editor_iframe.contentWindow.document;
                if(iframe_doc){
                    let iframe_body=iframe_doc.querySelector('body.cke_editable');
                    if(iframe_body){
                        let pts=iframe_body.querySelector('.pts');
                        if(pts){
                            all_check.checked=true;
                            return 1; }
                        else{
                            all_check.checked=false;
                            return 0; }}}}
            else{
                return -1; }}


        function insert_ptag(n){
            let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
            if(editor_iframe){ // iframeèª­è¾¼ã¿ãŒå®Ÿè¡Œæ¡ä»¶
                let iframe_doc=editor_iframe.contentWindow.document;
                if(iframe_doc){
                    let iframe_body=iframe_doc.querySelector('body.cke_editable');
                    if(iframe_body){

                        if(n==0){
                            let pts=iframe_body.querySelector('.pts');
                            if(pts){
                                pts.remove(); }}

                        if(n==1){
                            // style_ptext ã‚’ç·¨é›†ã—ã¦ SNSãƒœã‚¿ãƒ³ã®éè¡¨ç¤ºå†…å®¹ã‚’å¤‰æ›´å‡ºæ¥ã¾ã™ â­•
                            let style_ptext=
                                '<style class="pts" type="text/css">'+
                                '[data-uranus-component="entryAction"], '+
                                '[data-uranus-component="feedbacks"], '+

                                // ä»¥ä¸‹ã¯ æ–°ã‚¿ã‚¤ãƒ—ã‚¹ã‚­ãƒ³å¯¾å¿œã§è¿½åŠ 
                                '[data-uranus-component="entryShare"], '+
                                '[data-uranus-component="mainWidget"], '+

                                // ä»¥ä¸‹ã¯ æ—§ã‚¿ã‚¤ãƒ—ã‚¹ã‚­ãƒ³å¯¾å¿œã§è¿½åŠ ï¼ˆå¯¾å¿œä¸è¦ãªã‚‰å‰Šé™¤å¯ï¼‰
                                '.articleExLinkArea, '+
                                '.reblogArea, '+
                                '.commentArea, '+
                                '.pagingArea:nth-of-type(3), '+

                                // ä»¥ä¸‹ã¯ ãƒ¬ãƒˆãƒ­ã‚¿ã‚¤ãƒ—ã‚¹ã‚­ãƒ³å¯¾å¿œã§è¿½åŠ ï¼ˆå¯¾å¿œä¸è¦ãªã‚‰å‰Šé™¤å¯ï¼‰
                                '#exLinkBtn, '+
                                '#comment_module, '+

                                // ä»¥ä¸‹ã¯ ã‚¹ãƒãƒ›ã‚¹ã‚­ãƒ³å¯¾å¿œ
                                '._1oW7Td1- { display: none; }'+
                                '</style>';

                            iframe_body.insertAdjacentHTML('beforeend', style_ptext); } // style.ptsã‚’è¿½åŠ 

                    }}}} // insert_ptag(n)


        function panel_add(){
            let l_comm=document.querySelector('.l-communication');
            let p_comm=document.querySelector('.l-communication div:first-child');
            let i_input=p_comm.querySelector('#allFlg');

            if(!i_input){
                let add_comm=p_comm.cloneNode(true);
                let c_title=add_comm.querySelector('h2');
                c_title.textContent='å…¨SNSæ©Ÿèƒ½';
                let c_input=add_comm.querySelector('#commentFlg');
                c_input.setAttribute('name', 'allFlg');
                c_input.setAttribute('id', 'allFlg');
                let allFlg_text=add_comm.querySelector('.spui-Checkbox-text');
                allFlg_text.textContent='Close';

                l_comm.insertBefore(add_comm, p_comm); }


            let commFlg_text=l_comm.querySelector('#commentFlg ~ .spui-Checkbox-text');
            commFlg_text.textContent='Close';

            let reblogFlg_text=l_comm.querySelector('#reblogFlg ~ .spui-Checkbox-text');
            reblogFlg_text.textContent='Close';

        } // panel_add()


        // ä»¥ä¸‹ã® style_text ã‚’ç·¨é›†ã™ã‚‹ã¨ å¸¸è¨­ styleã‚¿ã‚°å†…å®¹ã‚’å¤‰æ›´å‡ºæ¥ã¾ã™ â­•
        let style_text=
            '<style class="asa" type="text/css">'+
            '@import url("https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"); '+
            '</style>';

        let submitButton=document.querySelectorAll('.js-submitButton');
        submitButton[0].addEventListener('mousedown', insert_tag , false);
        submitButton[1].addEventListener('mousedown', insert_tag , false);

        function insert_tag(e){
            let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
            if(editor_iframe){ // iframeèª­è¾¼ã¿ãŒå®Ÿè¡Œæ¡ä»¶
                let iframe_doc=editor_iframe.contentWindow.document;
                if(iframe_doc){
                    let iframe_body=iframe_doc.querySelector('body.cke_editable');

                    if(iframe_body.querySelector('.asa')){
                        iframe_body.querySelector('.asa').remove(); } // æ—¢ã«æ›¸è¾¼ã¾ã‚Œã¦ã„ãŸã‚‰å‰Šé™¤ã—ã¦æ›´æ–°ã™ã‚‹
                    iframe_body.insertAdjacentHTML('beforeend', style_text); }} // è¨˜äº‹æœ«å°¾ã« style.asaã‚’è¿½åŠ 
            else{
                e.stopImmediatePropagation();
                alert(
                    "ã€€â›”ã€€Auto Style Attach\n"+
                    "ã€€ã€€ã€€å¸¸è¨­ styleã‚¿ã‚° ã®æ›¸è¾¼ã¿ãƒ»æ›´æ–°ã®ãŸã‚\n"+
                    "ã€€ã€€ã€€é€šå¸¸è¡¨ç¤ºç”»é¢ã‹ã‚‰æŠ•ç¨¿ã‚’ã—ã¦ãã ã•ã„"); }}

    } // catch_publish()

} // main()


